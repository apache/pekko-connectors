# SPDX-License-Identifier: Apache-2.0

pekko.connectors.s3 {
  # whether the buffer request chunks (up to 5MB each) to "memory" or "disk"
  buffer = "memory"

  # location for temporary files, if buffer is set to "disk". If empty, uses the standard java temp path.
  disk-buffer-path = ""

  # An address of a proxy that will be used for all connections using HTTP CONNECT tunnel.
  # forward-proxy {
  #   scheme = "https"
  #   host = "proxy"
  #   port = 8080
  #   credentials {
  #     username = "username"
  #     password = "password"
  #   }
  # }

  # default values for AWS configuration
  aws {
    # If this section is absent, the fallback behavior is
    # to use the same configuration as if credentials.provider = default
    credentials {
      # anonymous requests (no auth)
      #
      # provider = anon

      # static credentials
      #
      # provider = static
      # access-key-id = ""
      # secret-access-key = ""
      # token = "" # optional

      # default: as described in software.amazon.awssdk.auth.credentials.DefaultCredentialsProvider docs,
      # attempts to get the credentials from either:
      #   - environment variables
      #   - system properties
      #   - credentials file
      #   - EC2 credentials service
      #   - IAM / metadata
      provider = default
    }

    # If this section is absent, the fallback behavior is
    # to use the same configuration as if region.provider = default
    region {
      # static credentials
      #
      # provider = static
      #
      # This can be set to the `id` value of any of the regions defined in
      # software.amazon.awssdk.regions.Region
      # default-region = ""

      # default: as described in software.amazon.awssdk.regions.providers.DefaultAwsRegionProviderChain docs,
      # attempts to get the region from either:
      #   - environment variables
      #   - system properties
      #   - progile file
      #   - EC2 metadata
      provider = default
    }
  }

  # DEPRECATED (since Alpakka 2.0.0)
  # AWS S3 is going to retire path-style access, thus prefer the virtual-host-style access
  # https://aws.amazon.com/blogs/aws/amazon-s3-path-deprecation-plan-the-rest-of-the-story/
  #
  # Also, prefer to use the newer access-style property.
  #
  # Possible values:
  #  - false: use virtual-host style access
  #  - true: use legacy path-style access, warnings will be logged
  #  - force: use legacy path-style access, disable warnings
  #  - empty, null or absent (default): use `access-style`, which in turn defaults to virtual-host style access
  # path-style-access = false

  # Which access style to use. Prefer to use this setting over path-style-access.
  # Path-style access has been deprecated by Amazon and will not work on buckets created after September 30, 2020.
  # For alternative S3 implementations (MinIO, Rados Gateway, etc.), path-style access may continue to be required.
  # Possible values:
  #  - virtual: virtual host-style access, i.e. https://<bucket name>.s3.amazonaws.com/file/inside/bucket
  #  - path: path-style access, i.e. https://<region>.amazonaws.com/<bucket>/file/inside/bucket
  access-style = virtual

  # Custom endpoint url, used for alternate s3 implementations
  # To enable virtual-host-style access with Apache Pekko Connectors S3 use the placeholder `{bucket}` in the URL
  # eg. endpoint-url = "http://{bucket}.s3minio.pekko-connectors:9000"
  #
  # endpoint-url = null

  # Which version of the list bucket api to use. Set to 1 to use the old style version 1 API.
  # By default the newer version 2 api is used.
  list-bucket-api-version = 2

  # Object keys are validated to NOT use sub-directory selection with `..` to improve security.
  # This flag may disable the validation.
  # See https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html
  validate-object-key = true

  # Default settings corresponding to automatic retry of requests in an S3 stream.
  retry-settings {
    # The maximum number of additional attempts (following transient errors) that will be made to process a given
    # request before giving up.
    max-retries = 3

    # The minimum delay between request retries.
    min-backoff = 200ms

    # The maximum delay between request retries.
    max-backoff = 10s

    # Random jitter factor applied to retry delay calculation.
    random-factor = 0.0
  }

  # Settings specific to S3 multipart uploads.
  multipart-upload {

    retry-settings = ${pekko.connectors.s3.retry-settings}
  }

  # Add signature headers to requests when aws.credentials.provider is anon
  sign-anonymous-requests = true

  # An allow list of headers for each S3Request type as defined by the AWS specification - this merged with additional-allowed-headers
  allowed-headers {
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetObject.html#API_GetObject_RequestSyntax
    GetObject = [
      "Host",
      "If-Match",
      "If-Modified-Since",
      "If-None-Match",
      "If-Unmodified-Since",
      "Range",
      "x-amz-server-side-encryption-customer-algorithm",
      "x-amz-server-side-encryption-customer-key",
      "x-amz-server-side-encryption-customer-key-MD5",
      "x-amz-request-payer",
      "x-amz-expected-bucket-owner",
      "x-amz-checksum-mode"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_HeadObject.html#API_HeadObject_RequestSyntax
    HeadObject = [
      "Host",
      "If-Match",
      "If-Modified-Since",
      "If-None-Match",
      "If-Unmodified-Since",
      "Range",
      "x-amz-server-side-encryption-customer-algorithm",
      "x-amz-server-side-encryption-customer-key",
      "x-amz-server-side-encryption-customer-key-MD5",
      "x-amz-request-payer",
      "x-amz-expected-bucket-owner",
      "x-amz-checksum-mode"
    ]
    PutObject = [
      "Host",
      "x-amz-acl",
      "Cache-Control",
      "Content-Disposition",
      "Content-Encoding",
      "Content-Language",
      "Content-Length",
      "Content-MD5",
      "Content-Type",
      "x-amz-sdk-checksum-algorithm",
      "x-amz-checksum-crc32",
      "x-amz-checksum-crc32c",
      "x-amz-checksum-crc64nvme",
      "x-amz-checksum-sha1",
      "x-amz-checksum-sha256",
      "Expires",
      "If-Match",
      "If-None-Match",
      "x-amz-grant-full-control",
      "x-amz-grant-read",
      "x-amz-grant-read-acp",
      "x-amz-grant-write-acp",
      "x-amz-write-offset-bytes",
      "x-amz-server-side-encryption",
      "x-amz-storage-class",
      "x-amz-website-redirect-location",
      "x-amz-server-side-encryption-customer-algorithm",
      "x-amz-server-side-encryption-customer-key",
      "x-amz-server-side-encryption-customer-key-MD5",
      "x-amz-server-side-encryption-aws-kms-key-id",
      "x-amz-server-side-encryption-context",
      "x-amz-server-side-encryption-bucket-key-enabled",
      "x-amz-request-payer",
      "x-amz-tagging",
      "x-amz-object-lock-mode",
      "x-amz-object-lock-retain-until-date",
      "x-amz-object-lock-legal-hold",
      "x-amz-expected-bucket-owner"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateMultipartUpload.html#API_CreateMultipartUpload_RequestSyntax
    InitiateMultipartUpload = [
      "Host",
      "x-amz-acl",
      "Cache-Control",
      "Content-Disposition",
      "Content-Encoding",
      "Content-Language",
      "Content-Type",
      "Expires",
      "x-amz-grant-full-control",
      "x-amz-grant-read",
      "x-amz-grant-read-acp",
      "x-amz-grant-write-acp",
      "x-amz-server-side-encryption",
      "x-amz-storage-class",
      "x-amz-website-redirect-location",
      "x-amz-server-side-encryption-customer-algorithm",
      "x-amz-server-side-encryption-customer-key",
      "x-amz-server-side-encryption-customer-key-MD5",
      "x-amz-server-side-encryption-aws-kms-key-id",
      "x-amz-server-side-encryption-context",
      "x-amz-server-side-encryption-bucket-key-enabled",
      "x-amz-request-payer",
      "x-amz-tagging",
      "x-amz-object-lock-mode",
      "x-amz-object-lock-retain-until-date",
      "x-amz-object-lock-legal-hold",
      "x-amz-expected-bucket-owner",
      "x-amz-checksum-algorithm",
      "x-amz-checksum-type"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_UploadPart.html#API_UploadPart_RequestSyntax 
    UploadPart = [
      "Host",
      "Content-Length",
      "Content-MD5",
      "x-amz-sdk-checksum-algorithm",
      "x-amz-checksum-crc32",
      "x-amz-checksum-crc32c",
      "x-amz-checksum-crc64nvme",
      "x-amz-checksum-sha1",
      "x-amz-checksum-sha256",
      "x-amz-server-side-encryption-customer-algorithm",
      "x-amz-server-side-encryption-customer-key",
      "x-amz-server-side-encryption-customer-key-MD5",
      "x-amz-request-payer",
      "x-amz-expected-bucket-owner"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_UploadPartCopy.html#API_UploadPartCopy_RequestSyntax
    CopyPart = [
      "Host",
      "x-amz-copy-source",
      "x-amz-copy-source-if-match",
      "x-amz-copy-source-if-modified-since",
      "x-amz-copy-source-if-none-match",
      "x-amz-copy-source-if-unmodified-since",
      "x-amz-copy-source-range",
      "x-amz-server-side-encryption-customer-algorithm",
      "x-amz-server-side-encryption-customer-key",
      "x-amz-server-side-encryption-customer-key-MD5",
      "x-amz-copy-source-server-side-encryption-customer-algorithm",
      "x-amz-copy-source-server-side-encryption-customer-key",
      "x-amz-copy-source-server-side-encryption-customer-key-MD5",
      "x-amz-request-payer",
      "x-amz-expected-bucket-owner",
      "x-amz-source-expected-bucket-owner"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteObject.html#API_DeleteObject_RequestSyntax
    DeleteObject = [
      "Host",
      "x-amz-mfa",
      "x-amz-request-payer",
      "x-amz-bypass-governance-retention",
      "x-amz-expected-bucket-owner",
      "If-Match",
      "x-amz-if-match-last-modified-time",
      "x-amz-if-match-size"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListBuckets.html#API_ListBuckets_RequestSyntax
    ListBucket = [
      "Host"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateBucket.html#API_CreateBucket_RequestSyntax
    MakeBucket = [
      "Host",
      "x-amz-acl",
      "x-amz-grant-full-control",
      "x-amz-grant-read",
      "x-amz-grant-read-acp",
      "x-amz-grant-write",
      "x-amz-grant-write-acp",
      "x-amz-bucket-object-lock-enabled",
      "x-amz-object-ownership"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucket.html#API_DeleteBucket_RequestSyntax
    DeleteBucket = [
      "Host",
      "x-amz-expected-bucket-owner"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_HeadBucket.html#API_HeadBucket_RequestSyntax
    CheckBucket = [
      "Host",
      "x-amz-expected-bucket-owner"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_control_PutBucketVersioning.html#API_control_PutBucketVersioning_RequestSyntax
    PutBucketVersioning = [
      "Host",
      "Content-MD5",
      "x-amz-sdk-checksum-algorithm",
      "x-amz-mfa",
      "x-amz-expected-bucket-owner"
    ]
    # https://docs.aws.amazon.com/AmazonS3/latest/API/API_control_GetBucketVersioning.html#API_control_GetBucketVersioning_RequestSyntax
    GetBucketVersioning = [
      "Host",
      "x-amz-expected-bucket-owner"
    ]
  }

  # An additional allow list for each S3Request type for cases where non standard request headers are needed or the S3 specification evolves to include new headers
  additional-allowed-headers {
    GetObject = []
    HeadObject = []
    PutObject = []
    InitiateMultipartUpload = []
    UploadPart = []
    CopyPart = []
    DeleteObject = []
    ListBucket = []
    MakeBucket = []
    DeleteBucket = []
    CheckBucket = []
    PutBucketVersioning = []
    GetBucketVersioning = []
  }
}
